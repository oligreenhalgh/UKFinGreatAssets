{% extends "base.html" %}

{% block title %}Marketplace{% endblock %}

{% block content %}
<!-- AI-Ranked Bundles Header -->
<div class="bundle-header">
    <span class="bundle-header-icon">üèÜ</span>
    <span><strong>AI-Ranked Bundles:</strong> Investment opportunities ranked based on your portfolio and thesis.</span>
</div>

{% if results and results.deals_selected %}
<!-- Bundle Card -->
<div class="bundle-card">
    <div
        style="padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color);">
        <h3 style="margin: 0;">Optimal Investment Bundle</h3>
        <span class="match-badge">‚≠ê AI Optimized</span>
    </div>

    <div class="bundle-top">
        <div class="bundle-info">
            <div class="bundle-tags" id="bundleTags">
                {% for sector in results.sector_allocation.keys() %}
                {% if results.sector_allocation[sector] > 0 %}
                <span class="bundle-tag">{{ sector.replace('_', ' ') }}</span>
                {% endif %}
                {% endfor %}
            </div>

            <p class="bundle-description">
                Diversified bundle targeting dilution of focus sectors. Investments spread across
                {{ results.deals_selected|length }} deals in non-focus sectors to achieve optimal portfolio balance.
            </p>

            <div class="bundle-metrics">
                <div class="bundle-metric">
                    <div class="bundle-metric-value" id="bundleDeals">{{ results.deals_selected|length }}</div>
                    <div class="bundle-metric-label">Deals</div>
                </div>
                <div class="bundle-metric">
                    <div class="bundle-metric-value" id="bundleTotal">¬£{{ "{:,.0f}".format(results.total_investment_gbp)
                        }}</div>
                    <div class="bundle-metric-label">Total Investment</div>
                </div>
            </div>
        </div>

        <div class="analysis-section">
            <h4>üí° Why This Bundle?</h4>
            <p class="analysis-text">
                <strong>This bundle aligns with your thesis to dilute
                    {% if results.thesis.desired_sectors %}
                    {{ results.thesis.desired_sectors.keys()|list|join(' and ') }}
                    {% endif %}
                    exposure.</strong>
                The LP optimizer selected deals that maximize diversification while staying within your ¬£{{
                results.thesis.amount_millions }}M budget.
            </p>

            <h4>üìä Gap Analysis</h4>
            <p class="analysis-text">
                Addresses your overweight positions in focus sectors. Provides exposure to growth sectors
                that reduce portfolio concentration risk.
            </p>

            <h4>‚úì Thesis Alignment</h4>
            <ul class="analysis-list">
                <li>Dilution strategy targeting focus sectors</li>
                <li>Budget: ¬£{{ results.thesis.amount_millions }}M fully allocated</li>
                <li>Diversified across {{ results.sector_allocation|length }} sectors</li>
            </ul>

            <button class="bundle-expand-btn" onclick="toggleDeals()">
                ‚äï View Detailed Asset Breakdown
            </button>
        </div>
    </div>

    <!-- Deals Table -->
    <div class="bundle-deals" id="dealsSection" style="display: none;">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Deal ID</th>
                    <th>Sector</th>
                    <th>Investment</th>
                    <th>Allocation</th>
                    <th>Deal Size</th>
                    <th>Risk Score</th>
                </tr>
            </thead>
            <tbody id="dealsTable">
                {% for deal in results.deals_selected %}
                <tr>
                    <td style="font-weight: 600;">ASST{{ '%02d' % loop.index }}
                    </td>
                    <td><span class="badge badge-sector {{ deal.sector.lower().replace('&', '').replace(' ', '_') }}">{{
                            deal.sector.replace('_', ' ') }}</span></td>
                    <td style="color: var(--accent-cyan); font-weight: 600;">¬£{{ "{:,.2f}".format(deal.amount_gbp) }}
                    </td>
                    <td><span class="badge badge-loan">{{ (deal.fraction * 100)|round(1) }}%</span></td>
                    <td><span class="badge badge-loan">{% if deal.deal_size_gbp < 1000000 %}<¬£1M{% elif
                                deal.deal_size_gbp < 3000000 %}¬£1M-¬£3M{% elif deal.deal_size_gbp < 5000000 %}¬£3M-¬£5M{%
                                elif deal.deal_size_gbp < 10000000 %}¬£5M-¬£10M{% else %}>¬£10M{% endif %}</span></td>
                    <td><span class="badge badge-risk low">Low Risk</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <button class="buy-bundle-btn" onclick="buyBundle()">
        üõí Buy Bundle
    </button>
</div>

<!-- Sector Allocation Summary -->
<div class="card">
    <div class="card-header">
        <span>üìä</span> New Investment Sector Allocation
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
            {% for sector, weight in results.sector_allocation.items() %}
            <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                    <span class="badge badge-sector {{ sector.lower().replace('&', '').replace(' ', '_') }}"
                        style="font-size: 0.7rem; padding: 3px 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;">{{
                        sector.replace('_', ' ') }}</span>
                    <span
                        style="font-weight: 700; font-size: 0.85rem; color: {% if weight > 0 %}var(--accent-green){% else %}var(--text-muted){% endif %};">{{
                        (weight * 100)|round(1) }}%</span>
                </div>
                <div class="progress-bar" style="margin-top: 8px;">
                    <div class="progress-fill"
                        style="width: {{ weight * 100 }}%; background: {% if weight > 0 %}var(--gradient-green){% else %}var(--border-color){% endif %};">
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% else %}
<!-- No results yet -->
<div class="card">
    <div class="card-body" style="text-align: center; padding: 60px;">
        <div style="font-size: 4rem; margin-bottom: 20px;">üì≠</div>
        <h2 style="margin-bottom: 12px;">No Deal Recommendations Yet</h2>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">
            Upload an investment thesis on the Insights page to generate AI-optimized deal recommendations.
        </p>
        <a href="{{ url_for('insights') }}"
            style="color: var(--accent-purple); text-decoration: none; font-weight: 600;">
            ‚Üí Go to Insights
        </a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    function toggleDeals() {
        const section = document.getElementById('dealsSection');
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }

    async function buyBundle() {
        if (confirm('Confirm purchase of this investment bundle?')) {
            try {
                const response = await fetch('/api/purchase-bundle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ ' + data.message + '\n\nYour portfolio has been updated. Visit the Portfolio page to see the new distributions.');
                    // Optionally redirect to portfolio
                    if (confirm('Would you like to view your updated portfolio?')) {
                        window.location.href = '/portfolio';
                    }
                } else {
                    alert('‚ùå Purchase failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Purchase error:', error);
                alert('‚ùå Purchase failed. Please try again.');
            }
        }
    }

    // Poll for updates
    let lastTimestamp = 0;

    async function checkForUpdates() {
        try {
            const response = await fetch('/api/results-timestamp');
            const data = await response.json();

            if (data.exists && data.timestamp > lastTimestamp && lastTimestamp > 0) {
                // New results available, reload page
                location.reload();
            }
            lastTimestamp = data.timestamp;
        } catch (error) {
            console.error('Update check error:', error);
        }
    }

    // Check every 5 seconds
    setInterval(checkForUpdates, 5000);
    checkForUpdates();
</script>
{% endblock %}